#!/bin/bash
# Real-Time Stock Prediction Report Generator
# Usage: ./generate_realtime_predictions.sh [target_date]
# Example: ./generate_realtime_predictions.sh 20260114

set -e

# Configuration
DATABASE_URL="${DATABASE_URL:-postgresql://postgres:12341234@127.0.0.1:5432/research}"
WORKSPACE_ROOT="/Users/alex/stock-analysis-workspace"
OUTPUT_DIR="${WORKSPACE_ROOT}"

# Get target date (defaults to today in YYYYMMDD format)
TARGET_DATE="${1:-$(date +%Y%m%d)}"
REPORT_DATE=$(echo "$TARGET_DATE" | sed 's/\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)/\1-\2-\3/')

echo "=========================================="
echo "Real-Time Prediction Report Generator"
echo "=========================================="
echo "Target Date: $REPORT_DATE ($TARGET_DATE)"
echo "Database: $DATABASE_URL"
echo ""

# Step 1: Check data availability
echo "[1/5] Checking data availability..."
LATEST_DATE=$(psql "$DATABASE_URL" -t -c "SELECT MAX(trade_date) FROM ml_training_dataset;" | xargs)
echo "Latest available data: $LATEST_DATE"

if [ "$LATEST_DATE" = "" ]; then
    echo "ERROR: No data in ml_training_dataset. Run dataset_creator first."
    exit 1
fi

# Calculate prediction basis (yesterday's data)
PREV_DATE=$(psql "$DATABASE_URL" -t -c "SELECT MAX(trade_date) FROM ml_training_dataset WHERE trade_date < '$TARGET_DATE';" | xargs)
echo "Prediction basis: $PREV_DATE (features from previous trading day)"
echo ""

# Step 2: Generate market sentiment
echo "[2/5] Calculating market sentiment..."
SENTIMENT=$(psql "$DATABASE_URL" -t -c "
SELECT 
    COUNT(*) as stocks,
    ROUND(AVG(close_pct)::numeric, 4) as avg_close,
    ROUND(AVG(price_momentum_5)::numeric, 4) as avg_momentum,
    ROUND(AVG(rsi_14)::numeric, 2) as avg_rsi,
    ROUND(AVG(volume_ratio)::numeric, 4) as avg_vol_ratio,
    ROUND(AVG(index_csi300_pct_chg)::numeric, 4) as csi300_chg
FROM ml_training_dataset 
WHERE trade_date = '$PREV_DATE';
" | xargs)

echo "Market Stats: $SENTIMENT"
echo ""

# Step 3: Extract top bullish signals
echo "[3/5] Identifying top bullish signals..."
psql "$DATABASE_URL" -c "
SELECT 
    ts_code,
    ROUND(close_pct::numeric, 2) as close_pct,
    ROUND(price_momentum_5::numeric, 4) as momentum_5d,
    ROUND(volume_ratio::numeric, 2) as vol_ratio,
    ROUND(ema_5::numeric, 2) as ema_5,
    ROUND(rsi_14::numeric, 1) as rsi
FROM ml_training_dataset 
WHERE trade_date = '$PREV_DATE' 
  AND price_momentum_5 IS NOT NULL
ORDER BY price_momentum_5 DESC 
LIMIT 20;
" > "/tmp/bullish_signals_$TARGET_DATE.txt"

echo "Saved to /tmp/bullish_signals_$TARGET_DATE.txt"
echo ""

# Step 4: Extract top bearish signals
echo "[4/5] Identifying top bearish signals..."
psql "$DATABASE_URL" -c "
SELECT 
    ts_code,
    ROUND(close_pct::numeric, 2) as close_pct,
    ROUND(price_momentum_5::numeric, 4) as momentum_5d,
    ROUND(volume_ratio::numeric, 2) as vol_ratio,
    ROUND(ema_5::numeric, 2) as ema_5,
    ROUND(rsi_14::numeric, 1) as rsi
FROM ml_training_dataset 
WHERE trade_date = '$PREV_DATE' 
  AND price_momentum_5 IS NOT NULL
ORDER BY price_momentum_5 ASC 
LIMIT 20;
" > "/tmp/bearish_signals_$TARGET_DATE.txt"

echo "Saved to /tmp/bearish_signals_$TARGET_DATE.txt"
echo ""

# Step 5: Generate markdown report
echo "[5/5] Generating markdown report..."

OUTPUT_FILE="${OUTPUT_DIR}/REALTIME_PREDICTIONS_${TARGET_DATE}.md"

cat > "$OUTPUT_FILE" << EOF
# ðŸ“Š REAL-TIME MARKET PREDICTIONS - $(date -j -f "%Y%m%d" "$TARGET_DATE" "+%B %d, %Y")

**Report Generated:** $(date)  
**Prediction Basis:** Data through $PREV_DATE  
**Target:** $REPORT_DATE closing prices  
**Model:** best_model.safetensors  

---

## ðŸŽ¯ MARKET SENTIMENT

\`\`\`
$SENTIMENT
\`\`\`

---

## ðŸš€ TOP 20 BULLISH SIGNALS

\`\`\`
$(cat /tmp/bullish_signals_$TARGET_DATE.txt)
\`\`\`

---

## ðŸ“‰ TOP 20 BEARISH SIGNALS

\`\`\`
$(cat /tmp/bearish_signals_$TARGET_DATE.txt)
\`\`\`

---

## ðŸ“‹ USAGE INSTRUCTIONS

### Buy Candidates
Focus on stocks with:
- High momentum_5d (>0.5)
- Volume ratio >1.0 (strong buying)
- RSI 50-70 (not overbought)

### Sell/Avoid Candidates
Avoid stocks with:
- Negative momentum_5d (<-0.1)
- Volume ratio <0.8 (weak interest)
- RSI <30 or >70 (oversold/overbought)

---

**Generated by:** generate_realtime_predictions.sh  
**Data Source:** ml_training_dataset  
**Stocks Analyzed:** $(echo $SENTIMENT | awk '{print $1}')  
EOF

echo "âœ… Report saved to: $OUTPUT_FILE"
echo ""
echo "=========================================="
echo "SUMMARY"
echo "=========================================="
head -30 "$OUTPUT_FILE"
echo ""
echo "Full report: $OUTPUT_FILE"
